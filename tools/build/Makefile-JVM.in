JAVA    = java
JAVAC   = javac
JAR     = jar
PERL    = perl
PROVE   = prove
NQP     = @nqp@
GEN_CAT = tools/build/gen-cat.pl jvm

PREFIX = @prefix@

MKPATH = $(PERL) -MExtUtils::Command -e mkpath
CP     = $(PERL) -MExtUtils::Command -e cp
CHMOD  = $(PERL) -MExtUtils::Command -e chmod
RM_F   = $(PERL) -MExtUtils::Command -e rm_f

# files we create
PERL6_CLASS     = perl6.class
PERL6_ML_CLASS  = blib/Perl6/ModuleLoader.class
PERL6_CF_CLASS  = blib/Perl6/ConstantFolder.class
PERL6_W_CLASS   = blib/Perl6/World.class
PERL6_G_CLASS   = blib/Perl6/Grammar.class
PERL6_OPS_CLASS = blib/Perl6/Ops.class
PERL6_A_CLASS   = blib/Perl6/Actions.class
PERL6_O_CLASS   = blib/Perl6/Optimizer.class
PERL6_P_CLASS   = blib/Perl6/Pod.class
PERL6_C_CLASS   = blib/Perl6/Compiler.class
PERL6_M_CLASS   = blib/Perl6/Metamodel.class
PERL6_B_CLASS   = blib/Perl6/BOOTSTRAP.class
SETTING_CLASS   = CORE.setting.class
R_SETTING_CLASS = RESTRICTED.setting.class

METAMODEL_SOURCES = \
  src/Perl6/Metamodel/Archetypes.nqp \
  src/Perl6/Metamodel/Naming.nqp \
  src/Perl6/Metamodel/Documenting.nqp \
  src/Perl6/Metamodel/Stashing.nqp \
  src/Perl6/Metamodel/Versioning.nqp \
  src/Perl6/Metamodel/TypePretense.nqp \
  src/Perl6/Metamodel/MethodDelegation.nqp \
  src/Perl6/Metamodel/BoolificationProtocol.nqp \
  src/Perl6/Metamodel/PackageHOW.nqp \
  src/Perl6/Metamodel/ModuleHOW.nqp \
  src/Perl6/Metamodel/GenericHOW.nqp \
  src/Perl6/Metamodel/AttributeContainer.nqp \
  src/Perl6/Metamodel/MethodContainer.nqp \
  src/Perl6/Metamodel/PrivateMethodContainer.nqp \
  src/Perl6/Metamodel/MultiMethodContainer.nqp \
  src/Perl6/Metamodel/RoleContainer.nqp \
  src/Perl6/Metamodel/MultipleInheritance.nqp \
  src/Perl6/Metamodel/DefaultParent.nqp \
  src/Perl6/Metamodel/BaseType.nqp \
  src/Perl6/Metamodel/C3MRO.nqp \
  src/Perl6/Metamodel/MROBasedMethodDispatch.nqp \
  src/Perl6/Metamodel/MROBasedTypeChecking.nqp \
  src/Perl6/Metamodel/Trusting.nqp \
  src/Perl6/Metamodel/Mixins.nqp \
  src/Perl6/Metamodel/BUILDPLAN.nqp \
  src/Perl6/Metamodel/REPRAttributeProtocol.nqp \
  src/Perl6/Metamodel/InvocationProtocol.nqp \
  src/Perl6/Metamodel/RolePunning.nqp \
  src/Perl6/Metamodel/RoleToRoleApplier.nqp \
  src/Perl6/Metamodel/ConcreteRoleHOW.nqp \
  src/Perl6/Metamodel/CurriedRoleHOW.nqp \
  src/Perl6/Metamodel/ParametricRoleHOW.nqp \
  src/Perl6/Metamodel/ParametricRoleGroupHOW.nqp \
  src/Perl6/Metamodel/RoleToClassApplier.nqp \
  src/Perl6/Metamodel/ClassHOW.nqp \
  src/Perl6/Metamodel/GrammarHOW.nqp \
  src/Perl6/Metamodel/NativeHOW.nqp \
  src/Perl6/Metamodel/SubsetHOW.nqp \
  src/Perl6/Metamodel/EnumHOW.nqp \
  src/Perl6/Metamodel/ContainerDescriptor.nqp \
  src/Perl6/Metamodel/StaticLexPad.nqp \
  src/Perl6/Metamodel/Dispatchers.nqp \

BOOTSTRAP_SOURCES = \
  src/Perl6/Metamodel/BOOTSTRAP.nqp \
  src/Perl6/Metamodel/EXPORTHOW.nqp \

CLEANUPS = \
  *.manifest \
  blib/Perl6/*.class \
  $(SETTING_CLASS) \
  $(R_SETTING_CLASS) \
  lib/Test.class \
  lib/lib.class \
  lib/Pod/To/Text.class \
  rakudo_test_run.tar.gz \
  src/gen/CORE.setting \
  src/gen/*.class \
  src/gen/*.pm \

all: $(PERL6_CLASS) $(PERL6_B_CLASS)

$(PERL6_ML_CLASS): src/Perl6/ModuleLoader.nqp src/vm/jvm/ModuleLoaderVMConfig.nqp
	$(PERL) $(GEN_CAT) src/vm/jvm/ModuleLoaderVMConfig.nqp src/Perl6/ModuleLoader.nqp > src/gen/ModuleLoader.nqp
	$(NQP) --target=classfile --output=$(PERL6_ML_CLASS) --encoding=utf8 \
	    src/gen/ModuleLoader.nqp

$(PERL6_CF_CLASS): src/Perl6/ConstantFolder.nqp
	$(NQP) --target=classfile --output=$(PERL6_CF_CLASS) --encoding=utf8 \
	    src/Perl6/ConstantFolder.nqp

$(PERL6_W_CLASS): $(PERL6_ML_CLASS) src/Perl6/World.nqp
	$(NQP) --target=classfile --output=$(PERL6_W_CLASS) --encoding=utf8 \
	    src/Perl6/World.nqp

$(PERL6_P_CLASS): src/Perl6/Pod.nqp
	$(NQP) --target=classfile --output=$(PERL6_P_CLASS) --encoding=utf8 \
	    src/Perl6/Pod.nqp

$(PERL6_OPS_CLASS): src/vm/jvm/Perl6/Ops.nqp
	$(NQP) --target=classfile --output=$(PERL6_OPS_CLASS) --encoding=utf8 \
	    src/vm/jvm/Perl6/Ops.nqp

$(PERL6_A_CLASS): src/Perl6/Actions.nqp $(PERL6_P_CLASS) $(PERL6_CF_CLASS) $(PERL6_OPS_CLASS)
	$(NQP) --target=classfile --output=$(PERL6_A_CLASS) --encoding=utf8 \
	    src/Perl6/Actions.nqp

$(PERL6_G_CLASS): src/Perl6/Grammar.nqp $(PERL6_W_CLASS) $(PERL6_A_CLASS) $(PERL6_P_CLASS)
	$(NQP) --target=classfile --output=$(PERL6_G_CLASS) --encoding=utf8 \
	    src/Perl6/Grammar.nqp

$(PERL6_O_CLASS): src/Perl6/Optimizer.nqp $(PERL6_OPS_CLASS)
	$(NQP) --target=classfile --output=$(PERL6_O_CLASS) --encoding=utf8 \
	    src/Perl6/Optimizer.nqp

$(PERL6_C_CLASS): src/Perl6/Compiler.nqp $(PERL6_O_CLASS)
	$(NQP) --target=classfile --output=$(PERL6_C_CLASS) --encoding=utf8 \
	    src/Perl6/Compiler.nqp

$(PERL6_CLASS): src/main.nqp $(PERL6_G_CLASS) $(PERL6_A_CLASS) $(PERL6_C_CLASS) $(PERL6_P_CLASS)
	$(PERL) tools/build/gen-version.pl > src/gen/main-version.nqp
	$(PERL) $(GEN_CAT) src/main.nqp src/gen/main-version.nqp > src/gen/main.nqp
	$(NQP) --target=classfile --javaclass=perl6 --output=$(PERL6_CLASS) \
	    src/gen/main.nqp

$(PERL6_M_CLASS): $(METAMODEL_SOURCES)
	$(PERL) $(GEN_CAT) $(METAMODEL_SOURCES) > src/gen/Metamodel.nqp
	$(NQP) --target=classfile --output=$(PERL6_M_CLASS) --encoding=utf8 \
	    src/gen/Metamodel.nqp

$(PERL6_B_CLASS): $(BOOTSTRAP_SOURCES) $(PERL6_M_CLASS)
	$(PERL) $(GEN_CAT) $(BOOTSTRAP_SOURCES) > src/gen/BOOTSTRAP.nqp
	$(NQP) --target=classfile --output=$(PERL6_B_CLASS) --encoding=utf8 \
	    src/gen/BOOTSTRAP.nqp

##  cleaning
clean:
	$(RM_F) $(CLEANUPS)

distclean: realclean

realclean: clean
	$(RM_F) Makefile

testclean:
